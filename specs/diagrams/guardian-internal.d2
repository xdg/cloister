# Guardian Architecture: Container + Host Process
direction: down

container: cloister-guardian container {
  style.fill: "#f8f4e8"
  style.stroke: "#a84"

  proxy: "Proxy Server\n:3128" {
    style.fill: "#fff8e8"
    style.stroke: "#a84"
  }

  request_server: "Request Server\n:9998" {
    style.fill: "#fff8e8"
    style.stroke: "#a84"
  }

  approval_server: "Approval Server\n:9999" {
    style.fill: "#f8f4e8"
    style.stroke: "#a84"
  }

  tcp_client: "TCP Client" {
    style.fill: "#e8f8e8"
    style.stroke: "#4a4"
  }

  request_server -> approval_server: pending request
  approval_server -> request_server: approval/denial

  approval_server -> tcp_client: approved hostexec
  tcp_client -> approval_server: command result
}

host: Host Process (cloister binary) {
  style.fill: "#e8f8e8"
  style.stroke: "#4a4"

  tcp_server: "TCP Server\n127.0.0.1:<port>" {
    style.fill: "#d8f0d8"
  }

  executor: "Command Executor" {
    style.fill: "#d8f0d8"
  }

  tcp_server -> executor: execute
  executor -> tcp_server: stdout/stderr/exit
}

# TCP IPC via host.docker.internal
container.tcp_client <-> host.tcp_server: TCP\n(host.docker.internal) {
  style.stroke: "#4a4"
  style.stroke-dash: 3
}

# External connections
cloisters: "Cloisters\n(cloister-net)" {
  style.fill: "#e8f4f8"
  style.stroke: "#68b"
}

internet: "Internet\n(via bridge)" {
  style.fill: "#f4e8f8"
  style.stroke: "#a4a"
}

browser: "Browser" {
  style.fill: "#fff"
  style.stroke: "#888"
}

cloisters -> container.proxy: HTTP CONNECT
cloisters -> container.request_server: POST /request
container.proxy -> internet: allowlisted
browser -> container.approval_server: localhost:9999

# vim: set ts=2 sts=2 sw=2 et tw=75:
