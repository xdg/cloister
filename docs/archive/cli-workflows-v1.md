# Cloister CLI and Workflows

This document covers the cloister CLI commands and common workflow patterns.

For the main design and architecture, see [cloister-spec.md](cloister-spec.md).

---

## CLI Commands

### Project Management

```bash
cloister project list                       # List registered projects
cloister project show <name>                # Show project config and worktrees
cloister project edit <name>                # Open project config in $EDITOR
cloister project remove <name>              # Unregister project (keeps files)
cloister project init                       # Import .cloister.yaml from current repo
```

### Cloister Lifecycle

```bash
cloister new [options]                      # Start new cloister (project auto-detected)
cloister list                               # List running cloisters
cloister join <cloister-name>               # Attach to running cloister
cloister stop <cloister-name>               # Stop cloister
cloister stop --all                         # Stop all cloisters
cloister logs <cloister-name>               # View cloister audit log
cloister reset <cloister-name>              # Recreate cloister container
```

### Worktree Management

```bash
cloister worktree list <project>            # List worktrees for project
cloister worktree remove <project> <branch> # Remove cloister-managed worktree
```

### Infrastructure

```bash
cloister build                              # Rebuild default image
cloister guardian                           # Run guardian in foreground
cloister guardian start                     # Start guardian as background daemon
cloister guardian stop                      # Stop guardian daemon
cloister guardian status                    # Show guardian status
```

The `cloister guardian` command (no subcommand) runs the guardian in the foreground, useful for debugging or systemd/launchd integration. The `start` subcommand spawns the guardian as a background process.

---

## Options for `cloister new`

```
--path <dir>            Working directory (default: current directory)
--worktree <branch>     Create/use worktree for branch (in central location)
--agent <name>          AI agent to configure (default: from project or global config)
--ref <dir>             Read-only reference mount (repeatable, adds to project refs)
--reset                 Destroy existing cloister and recreate
--devcontainer          Use project's devcontainer.json
--devcontainer=<path>   Use specific devcontainer.json
--no-devcontainer       Ignore devcontainer.json even if present
--allow-no-git          Allow non-git directory (required if path not in git repo)
--shell <shell>         Shell to use (default: /bin/bash)
```

Project is auto-detected from `--path`. If the project is not registered, it is created automatically from the git remote URL. Cloister name is generated as `<project>-<branch>`.

---

## Environment Setup

The launcher sets these in the container:

```bash
HTTP_PROXY=http://cloister-guardian:3128
HTTPS_PROXY=http://cloister-guardian:3128
CLOISTER_GUARDIAN_HOST=cloister-guardian
CLOISTER_TOKEN=<random-hex>    # 32 bytes, hex-encoded; used for guardian auth

# Agent-specific (if --agent specified, not an exhaustive list)
ANTHROPIC_API_KEY=<from host>  # for claude
OPENAI_API_KEY=<from host>     # for codex
# etc.
```

The `CLOISTER_TOKEN` is generated by the CLI and registered with the guardian before the container starts. The guardian uses this token as the sole source of identity.

The container's hostname is set to the cloister name (e.g., `--hostname my-api-main`), making it available as `$HOSTNAME` for shell prompts and scripts. Project and branch information can be derived from the git repository in `/work` if needed.

---

## Project Detection

When starting a cloister, the launcher identifies the project through the following steps:

1. **Check git status**: Run `git rev-parse --git-dir` in target path
   - If fails and `--allow-no-git` not set: error with explanation
   - If fails and `--allow-no-git` set: use directory basename as project name, display prominent warning

2. **Get remote URL**: Run `git remote get-url origin`
   - If no remote: use directory basename, warn about local-only repo

3. **Match to registered project**: Check `~/.config/cloister/projects/*.yaml` for matching remote
   - If found: use that project's config
   - If not found: auto-register new project

4. **Auto-registration**:
   - Derive name from remote URL: `git@github.com:user/repo.git` → `repo`
   - Handle collisions by appending `-2`, `-3`, etc.
   - Create `~/.config/cloister/projects/<name>.yaml` with remote URL and detected root
   - Log: `Registered new project: <name>`

5. **Determine branch**: Run `git branch --show-current`
   - Detached HEAD: use short commit hash
   - Generate cloister name: `<project>-<branch>`

---

## Non-Git Warning

When `--allow-no-git` is used, display prominently:

```
⚠️  WARNING: Non-git directory mode

This directory is not tracked by git. The cloister can make destructive
changes with no version control safety net.

Recommended: Initialize a git repo first:
  git init && git add -A && git commit -m "initial"

Continuing in 5 seconds... (Ctrl+C to cancel)
```

---

## Workflows

### Starting a Session (Without Devcontainer)

```bash
$ cd ~/repos/my-api
$ cloister new --agent claude

Detected remote: git@github.com:xdg/my-api.git
Registered new project: my-api

Creating cloister: my-api-main
  Project: my-api (~/repos/my-api)
  Branch: main
  Network: cloister-net (internal)
  Proxy: cloister-guardian:3128
  Agent: claude

Entering cloister. Type 'exit' to leave.
cloister@my-api-main:/work$ claude
```

### Starting a Session (With Devcontainer)

```bash
$ cd ~/repos/my-api
$ cloister new --devcontainer --agent claude

Detected remote: git@github.com:xdg/my-api.git
Using registered project: my-api

Found .devcontainer/devcontainer.json
Building image with features:
  • ghcr.io/devcontainers/features/go:1
  • ghcr.io/devcontainers/features/node:1

Security overrides applied:
  • Network: cloister-net (internal)
  • Blocked mounts: ~/.ssh, ~/.aws, ~/.gnupg
  • Capabilities: ALL dropped

Running postCreateCommand via proxy...
  $ npm install
  added 342 packages in 12s

Creating cloister: my-api-main
Entering cloister. Type 'exit' to leave.
cloister@my-api-main:/work$ claude
```

### Dual-Container Workflow

```bash
# Terminal 1: Human devcontainer (VS Code)
$ code ~/repos/my-api
# Opens with full devcontainer, all credentials

# Terminal 2: AI cloister
$ cd ~/repos/my-api
$ cloister new --devcontainer --agent claude
cloister@my-api-main:/work$ claude
# AI working with same tools, restricted network

# Human reviews AI changes (in VS Code or host terminal)
$ git diff
$ npm test
$ git commit -am "feat: add feature from AI"
$ git push  # Human-initiated, has credentials
```

### Multi-Project Sessions

```bash
# Multiple cloisters running simultaneously
$ cloister new --path ~/repos/my-api --agent claude &
$ cloister new --path ~/repos/frontend --agent codex &
$ cloister new --path ~/repos/shared-lib --agent aider &

# Single guardian serves all
$ cloister list
CLOISTER              PROJECT      BRANCH    AGENT    STATUS    UPTIME
my-api-main           my-api       main      claude   running   2h 15m
frontend-main         frontend     main      codex    running   45m
shared-lib-main       shared-lib   main      aider    running   10m

# View unified approval queue on http://localhost:9999
$ cloister watch

# Per-cloister logs
$ cloister logs my-api-main
```

### AI Editing Flow with Approval

![Approval Flow](diagrams/approval-flow.svg) ([diagram source](diagrams/approval-flow.d2))

### Worktree-Based Development

Work on multiple branches simultaneously with isolated cloisters sharing project permissions:

```bash
# First use auto-registers the project
$ cd ~/repos/my-api
$ cloister new --agent claude
Detected remote: git@github.com:xdg/my-api.git
Registered new project: my-api
Creating cloister: my-api-main
Entering cloister...

# Later: work on a feature branch in parallel (in another terminal)
$ cloister new --worktree feature-auth --path ~/repos/my-api --agent claude
Creating worktree: ~/.local/share/cloister/worktrees/my-api/feature-auth
Creating cloister: my-api-feature-auth
Entering cloister...

# Both cloisters share project permissions
$ cloister list
CLOISTER              PROJECT    BRANCH        AGENT    STATUS
my-api-main           my-api     main          claude   running
my-api-feature-auth   my-api     feature-auth  claude   running

# Customize project permissions (applies to ALL cloisters for this project)
$ cloister project edit my-api
# Opens ~/.config/cloister/projects/my-api.yaml in $EDITOR
```

### Bootstrapping Project Config

Projects can include a `.cloister.yaml` template for team-shared defaults. This file is **never read at runtime**—it's purely a bootstrap template to prevent the AI from modifying its own permissions.

```bash
$ cd ~/repos/team-project
$ cat .cloister.yaml
# Recommended cloister config for this project
refs:
  - "../shared-protos"
proxy:
  allow:
    - domain: "internal-docs.example.com"
commands:
  auto_approve:
    - pattern: "^make test$"

# Import the template into your config
$ cloister project init
Detected remote: git@github.com:company/team-project.git
Importing .cloister.yaml → ~/.config/cloister/projects/team-project.yaml
Review and customize: cloister project edit team-project
```
